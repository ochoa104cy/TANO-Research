<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CMMC Level 2 Assessment Wizard — TANO Research</title>
  <link rel="stylesheet" href="../styles.css" />
  <style>
    /* Reuse same styles as Level1 for consistency */
    .wizard-steps {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .wizard-step-pill {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      border: 1px solid #444;
      font-size: 0.85rem;
      color: #aaa;
    }
    .wizard-step-pill.active {
      background: #301f2a;
      border-color: #ff8ab0;
      color: #fff;
      font-weight: 600;
    }
    .wizard-section { display:none; margin-top:0.5rem; }
    .wizard-section.active { display:block; }
    .field-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:1rem;
      margin-top:1rem;
    }
    .form-field label {
      font-size:0.9rem;
      color:#ccc;
      display:block;
      margin-bottom:0.25rem;
    }
    .form-field input,
    .form-field select,
    .form-field textarea {
      width:100%;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #444;
      background:#111;
      color:#fff;
      font-size:0.9rem;
    }
    .form-field textarea {
      resize:vertical;
      min-height:80px;
    }
    .scope-tags { display:flex; flex-wrap:wrap; gap:0.5rem; }
    .scope-tags label { font-size:0.85rem; }
    .control-grid {
      display:flex; flex-direction:column;
      gap:0.75rem; margin-top:1rem;
      max-height:480px; overflow-y:auto;
      border:1px solid #333; border-radius:6px;
      padding:0.75rem; background:#0d0d0d;
    }
    .control-card {
      border:1px solid #333; border-radius:6px;
      padding:0.5rem 0.75rem; background:#111;
    }
    .control-header {
      display:flex; justify-content:space-between;
      gap:0.75rem; align-items:baseline;
    }
    .control-id { font-weight:600; }
    .control-domain { font-size:0.85rem; color:#aaa; }
    .control-name { margin-top:0.15rem; font-size:0.95rem; }
    .control-desc { margin-top:0.25rem; font-size:0.85rem; color:#ccc; }
    .control-actions {
      display:grid;
      grid-template-columns:minmax(140px,190px) 1fr;
      gap:0.5rem 0.75rem;
      margin-top:0.5rem;
    }
    .status-select {
      width:100%;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #555;
      background:#151515;
      color:#fff;
      font-size:0.85rem;
    }
    .wizard-nav {
      margin-top:1rem;
      display:flex;
      justify-content:space-between;
      gap:0.5rem;
      flex-wrap:wrap;
    }
    .summary-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:1rem; margin-top:1rem;
    }
    .summary-card {
      border:1px solid #333;
      border-radius:6px;
      padding:0.75rem;
      background:#111;
    }
    .summary-card h3 { margin:0 0 0.3rem 0; font-size:1rem; }
    .summary-list { font-size:0.9rem; margin-top:0.5rem; }
    .summary-list li { margin-bottom:0.25rem; }
    .badge {
      display:inline-block;
      padding:0 0.4rem;
      border-radius:999px;
      font-size:0.75rem;
      border:1px solid #555;
      color:#ccc;
    }
  </style>
</head>
<body>
<div style="margin:1rem 0;">
  <a href="index.html" class="btn-primary">← Assessment Home</a>
  &nbsp;|&nbsp;
  <a href="../cmmc.html" class="btn-primary">← CMMC Center</a>
  &nbsp;|&nbsp;
  <a href="../index.html" class="btn-primary">← TANO Home</a>
</div>
<div class="card">
  <h1>CMMC Level 2 Assessment Wizard</h1>
  <p>
    Guided workflow for the 110 NIST SP 800-171 Rev.3 practices.
    Progress is saved locally (<code>tano_L2_meta</code> and <code>tano_L2_assessment</code>).
  </p>
<div class="wizard-steps">
    <div class="wizard-step-pill" data-step-pill="1">Step 1 — Org & System Profile</div>
    <div class="wizard-step-pill" data-step-pill="2">Step 2 — CUI & Risk Context</div>
    <div class="wizard-step-pill" data-step-pill="3">Step 3 — Practice Assessment</div>
    <div class="wizard-step-pill" data-step-pill="4">Step 4 — Summary & POA&M Hints</div>
  </div>
<!-- STEP 1 -->
  <section class="wizard-section" data-step="1">
    <h2>Step 1 — Organization & System Profile</h2>
    <div class="field-grid">
      <div class="form-field">
        <label for="orgName">Organization Name</label>
        <input id="orgName" type="text" />
      </div>
      <div class="form-field">
        <label for="assessorName">Assessor Name</label>
        <input id="assessorName" type="text" />
      </div>
      <div class="form-field">
        <label for="assessmentDate">Assessment Date</label>
        <input id="assessmentDate" type="date" />
      </div>
      <div class="form-field">
        <label for="systemName">System / Environment Name</label>
        <input id="systemName" type="text" placeholder="e.g., CUI Production Network" />
      </div>
      <div class="form-field">
        <label for="hasCUI">Does this system process CUI?</label>
        <select id="hasCUI">
          <option value="">Select…</option>
          <option>Yes</option>
          <option>No</option>
          <option>Planned</option>
        </select>
      </div>
    </div>
  </section>
<!-- STEP 2 -->
  <section class="wizard-section" data-step="2">
    <h2>Step 2 — CUI, Boundary, and Risk</h2>
<div class="form-field">
      <label>In-Scope Components</label>
      <div class="scope-tags">
        <label><input type="checkbox" class="scope-checkbox" value="On-prem servers" /> On-prem servers</label>
        <label><input type="checkbox" class="scope-checkbox" value="Cloud infrastructure" /> Cloud infrastructure</label>
        <label><input type="checkbox" class="scope-checkbox" value="Remote users" /> Remote users</label>
        <label><input type="checkbox" class="scope-checkbox" value="Third-party vendors" /> Third-party vendors</label>
        <label><input type="checkbox" class="scope-checkbox" value="OT / ICS" /> OT / ICS</label>
      </div>
    </div>
<div class="form-field" style="margin-top:1rem;">
      <label for="boundary">System Boundary (CUI Flow / Trust Zones)</label>
      <textarea id="boundary" placeholder="Describe where CUI is stored, processed, and transmitted, and any network segments, enclaves, or trust boundaries."></textarea>
    </div>
<div class="form-field" style="margin-top:1rem;">
      <label for="riskTolerance">Risk Tolerance / Business Impact</label>
      <textarea id="riskTolerance" placeholder="Summarize risk appetite, critical business impacts, and any mission-critical dependencies."></textarea>
    </div>
  </section>
<!-- STEP 3 -->
  <section class="wizard-section" data-step="3">
    <h2>Step 3 — Practice Assessment (110 Controls)</h2>
    <p>Review each Level 2 practice and record implementation status and notes.</p>
<div class="form-field">
      <label for="searchControls">Filter Practices</label>
      <input id="searchControls" type="text" placeholder="Search by ID, domain, or keyword…" />
    </div>
<div id="controlsContainer" class="control-grid">
      <!-- Level 2 practice cards injected here -->
    </div>
  </section>
<!-- STEP 4 -->
  <section class="wizard-section" data-step="4">
    <h2>Step 4 — Summary & POA&M Hints</h2>
<div id="summaryStats" class="summary-grid"></div>
<div class="summary-card" style="margin-top:1rem;">
      <h3>Controls Requiring POA&M</h3>
      <ul id="gapList" class="summary-list"></ul>
    </div>
<button class="btn-primary" type="button" onclick="downloadSummary()">
      Download Level 2 Summary (.txt)
    </button>
  </section>
<div class="wizard-nav">
    <button class="btn-secondary" type="button" id="prevBtn">← Previous</button>
    <button class="btn-primary" type="button" id="nextBtn">Next →</button>
  </div>
</div>
<footer>© TANO Research — Exploring Possibilities with Integrity Everywhere</footer>
<script>
const L2_CSV =
  "https://ochoa104cy.github.io/TANO-Research/cmmc-playbook/controls/L2_Practices.csv";
const META_KEY = "tano_L2_meta";
const ASSESS_KEY = "tano_L2_assessment";
let currentStep = 1;
const maxStep = 4;
let meta = {};
let assessment = {};
let allControls = [];
function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    return JSON.parse(raw);
  } catch { return fallback; }
}
function saveJSON(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}
/* Wizard nav */
function showStep(step) {
  currentStep = step;
  document.querySelectorAll(".wizard-section").forEach(sec => {
    sec.classList.toggle("active", Number(sec.dataset.step) === step);
  });
  document.querySelectorAll(".wizard-step-pill").forEach(pill => {
    pill.classList.toggle("active", Number(pill.dataset.stepPill) === step);
  });
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  prevBtn.disabled = step === 1;
  nextBtn.textContent = (step === maxStep) ? "Finish" : "Next →";
}
function nextStep() {
  if (currentStep < maxStep) {
    showStep(currentStep + 1);
    if (currentStep === maxStep) buildSummary();
  } else {
    buildSummary();
    alert("Level 2 assessment saved. Use the dashboard for full analytics.");
  }
}
function prevStep() {
  if (currentStep > 1) showStep(currentStep - 1);
}
/* CSV + controls */
function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  const rows = [];
  for (const line of lines) {
    const cells = [];
    let cur = "";
    let inQ = false;
    for (let i=0; i<line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i+1] === '"') { cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === "," && !inQ) {
        cells.push(cur);
        cur = "";
      } else {
        cur += ch;
      }
    }
    cells.push(cur);
    rows.push(cells.map(v => v.replace(/^"|"$/g, "")));
  }
  return rows;
}
function buildControls(rows) {
  const header = rows[0];
  const idxId   = header.indexOf("Practice ID");
  const idxDom  = header.indexOf("Domain");
  const idxName = header.indexOf("Practice Name");
  const idxDesc = header.indexOf("Description");
const container = document.getElementById("controlsContainer");
  container.innerHTML = "";
  allControls = [];
for (let i=1; i<rows.length; i++) {
    const r = rows[i];
    const id = r[idxId];
    if (!id) continue;
    const domain = r[idxDom] || "";
    const name = r[idxName] || "";
    const desc = r[idxDesc] || "";
if (!assessment[id]) assessment[id] = { status:"", notes:"" };
const card = document.createElement("div");
    card.className = "control-card";
    card.dataset.practiceId = id;
    card.innerHTML = `
      <div class="control-header">
        <div>
          <div class="control-id">${id}</div>
          <div class="control-domain">${domain}</div>
          <div class="control-name">${name}</div>
        </div>
      </div>
      <div class="control-desc">${desc}</div>
      <div class="control-actions">
        <div>
          <label style="font-size:0.8rem;">Status</label>
          <select class="status-select">
            <option value="">— Select —</option>
            <option value="Implemented">Implemented</option>
            <option value="Partially Implemented">Partially Implemented</option>
            <option value="Not Implemented">Not Implemented</option>
            <option value="N/A">Not Applicable</option>
            <option value="Out of Scope">Out of Scope</option>
          </select>
        </div>
        <div>
          <label style="font-size:0.8rem;">Notes / Evidence</label>
          <textarea>${assessment[id].notes || ""}</textarea>
        </div>
      </div>
    `;
    const select = card.querySelector("select");
    select.value = assessment[id].status || "";
    select.addEventListener("change", () => {
      assessment[id].status = select.value;
      saveJSON(ASSESS_KEY, assessment);
    });
    const notes = card.querySelector("textarea");
    notes.addEventListener("input", () => {
      assessment[id].notes = notes.value;
      saveJSON(ASSESS_KEY, assessment);
    });
container.appendChild(card);
    allControls.push({ id, domain, name, desc, element: card });
  }
  saveJSON(ASSESS_KEY, assessment);
}
/* search */
function setupSearch() {
  const input = document.getElementById("searchControls");
  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    allControls.forEach(c => {
      const text = (c.id+" "+c.domain+" "+c.name+" "+c.desc).toLowerCase();
      c.element.style.display = text.includes(q) ? "" : "none";
    });
  });
}
/* meta */
function loadMetaIntoForm() {
  document.getElementById("orgName").value = meta.orgName || "";
  document.getElementById("assessorName").value = meta.assessorName || "";
  document.getElementById("assessmentDate").value = meta.assessmentDate || "";
  document.getElementById("systemName").value = meta.systemName || "";
  document.getElementById("hasCUI").value = meta.hasCUI || "";
  document.getElementById("boundary").value = meta.boundary || "";
  document.getElementById("riskTolerance").value = meta.riskTolerance || "";
  const scopes = new Set(meta.scopes || []);
  document.querySelectorAll(".scope-checkbox").forEach(cb => {
    cb.checked = scopes.has(cb.value);
  });
}
function setupMetaListeners() {
  function sync() {
    meta.orgName = document.getElementById("orgName").value;
    meta.assessorName = document.getElementById("assessorName").value;
    meta.assessmentDate = document.getElementById("assessmentDate").value;
    meta.systemName = document.getElementById("systemName").value;
    meta.hasCUI = document.getElementById("hasCUI").value;
    meta.boundary = document.getElementById("boundary").value;
    meta.riskTolerance = document.getElementById("riskTolerance").value;
    const scopes = [];
    document.querySelectorAll(".scope-checkbox:checked").forEach(cb => scopes.push(cb.value));
    meta.scopes = scopes;
    saveJSON(META_KEY, meta);
  }
["orgName","assessorName","assessmentDate","systemName","hasCUI","boundary","riskTolerance"]
    .forEach(id => {
      document.getElementById(id).addEventListener("input", sync);
      document.getElementById(id).addEventListener("change", sync);
    });
  document.querySelectorAll(".scope-checkbox").forEach(cb => cb.addEventListener("change", sync));
}
/* summary */
function buildSummary() {
  const stats = { total:0, impl:0, partial:0, notImpl:0, na:0, outScope:0, none:0 };
  Object.entries(assessment).forEach(([id,v]) => {
    if (!id) return;
    stats.total++;
    switch (v.status) {
      case "Implemented": stats.impl++; break;
      case "Partially Implemented": stats.partial++; break;
      case "Not Implemented": stats.notImpl++; break;
      case "N/A": stats.na++; break;
      case "Out of Scope": stats.outScope++; break;
      default: stats.none++; break;
    }
  });
  const pctImpl = stats.total ? Math.round(stats.impl / stats.total * 100) : 0;
const summaryDiv = document.getElementById("summaryStats");
  summaryDiv.innerHTML = `
    <div class="summary-card">
      <h3>Overall Completion</h3>
      <p><strong>${stats.impl}/${stats.total}</strong> controls implemented (${pctImpl}%).</p>
      <p>${stats.partial} partial, ${stats.notImpl} not implemented, ${stats.na} N/A, ${stats.outScope} out of scope.</p>
    </div>
    <div class="summary-card">
      <h3>System Snapshot</h3>
      <p><strong>Org:</strong> ${meta.orgName || "—"}</p>
      <p><strong>System:</strong> ${meta.systemName || "—"}</p>
      <p><strong>CUI Present:</strong> ${meta.hasCUI || "—"}</p>
      <p><strong>Date:</strong> ${meta.assessmentDate || "—"}</p>
    </div>
    <div class="summary-card">
      <h3>Scope & Risk</h3>
      <p><strong>In scope:</strong> ${(meta.scopes || []).join(", ") || "—"}</p>
      <p style="margin-top:0.25rem;"><strong>Boundary:</strong><br>${meta.boundary || "—"}</p>
      <p style="margin-top:0.25rem;"><strong>Risk:</strong><br>${meta.riskTolerance || "—"}</p>
    </div>
  `;
const gapList = document.getElementById("gapList");
  gapList.innerHTML = "";
  const gaps = allControls.filter(c => {
    const st = (assessment[c.id] || {}).status || "";
    return st === "" || st === "Partially Implemented" || st === "Not Implemented";
  });
  gaps.forEach(c => {
    const st = (assessment[c.id] || {}).status || "Not Assessed";
    const li = document.createElement("li");
    li.innerHTML = `<span class="badge">${c.id}</span> ${c.name} — <em>${st}</em>`;
    gapList.appendChild(li);
  });
}
function downloadSummary() {
  buildSummary();
  let lines = [];
  lines.push("TANO Research — CMMC Level 2 Summary");
  lines.push("====================================");
  lines.push("");
  lines.push(`Organization: ${meta.orgName || ""}`);
  lines.push(`System:       ${meta.systemName || ""}`);
  lines.push(`Assessor:     ${meta.assessorName || ""}`);
  lines.push(`Date:         ${meta.assessmentDate || ""}`);
  lines.push(`CUI Present:  ${meta.hasCUI || ""}`);
  lines.push("");
  lines.push("Scope and Risk:");
  lines.push(`  In scope: ${(meta.scopes || []).join(", ") || "None listed"}`);
  lines.push(`  Boundary: ${meta.boundary || ""}`);
  lines.push(`  Risk:     ${meta.riskTolerance || ""}`);
  lines.push("");
  lines.push("Control statuses:");
  Object.entries(assessment).forEach(([id,v]) => {
    lines.push(`  ${id}: ${v.status || "Not Assessed"} | Notes: ${v.notes || ""}`);
  });
const blob = new Blob([lines.join("\n")], { type:"text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "TANO_CMMC_Level2_Summary.txt";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
/* init */
document.getElementById("prevBtn").addEventListener("click", prevStep);
document.getElementById("nextBtn").addEventListener("click", () => {
  if (currentStep === maxStep) buildSummary();
  nextStep();
});
meta = loadJSON(META_KEY, {});
assessment = loadJSON(ASSESS_KEY, {});
loadMetaIntoForm();
setupMetaListeners();
setupSearch();
fetch(L2_CSV)
  .then(r => r.text())
  .then(t => {
    const rows = parseCSV(t);
    buildControls(rows);
    showStep(1);
  })
  .catch(err => {
    console.error("Error loading L2 CSV", err);
    alert("Unable to load Level 2 practices CSV.");
    showStep(1);
  });
</script>
</body>
</html>
